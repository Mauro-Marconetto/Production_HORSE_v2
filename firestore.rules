/**
 * @fileoverview Firestore Security Rules for ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a permission model based on the data structure and
 * pre-defined security needs for each collection.
 *
 * Data Structure:
 * The Firestore database is structured to store information about Pieces,
 * Molds, Machines, Demand, Inventory, Calendar, Downtime, Plans, Assignments,
 * Production, and Settings. Each entity has its own collection, and
 * relationships between entities are maintained through document references.
 *
 * Key Security Decisions:
 * - Read access to the `users` collection is denied to prevent user enumeration.
 * - Global data collections (`pieces`, `molds`, `machines`, `production`) are publicly readable.
 * - Write access to global data collections is denied.
 * - User-specific subcollections (`assignments`) are only accessible by the user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows authenticated users to read Piece documents. Write operations are denied.
     * @path /databases/{database}/documents/pieces/{pieceId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Mold documents. Write operations are denied.
     * @path /databases/{database}/documents/molds/{moldId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Machine documents. Write operations are denied.
     * @path /databases/{database}/documents/machines/{machineId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Demand documents. Write operations are denied.
     * @path /databases/{database}/documents/demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Inventory documents. Write operations are denied.
     * @path /databases/{database}/documents/inventory/{pieceId}/{fechaISO}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Inventory documents. Write operations are denied.
     * @path /databases/{database}/documents/inventory/current/{pieceId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /inventory/current/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Calendar documents. Write operations are denied.
     * @path /databases/{database}/documents/calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Downtime documents. Write operations are denied.
     * @path /databases/{database}/documents/downtime/{machineId}/{YYYYMM}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read DowntimeAgg documents. Write operations are denied.
     * @path /databases/{database}/documents/downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Plan documents. Write operations are denied.
     * @path /databases/{database}/documents/plans/{planId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Assignment documents under a specific plan. Write operations are denied.
     * @path /databases/{database}/documents/plans/{planId}/assignments/{assignmentId}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Production documents. Write operations are denied.
     * @path /databases/{database}/documents/production/{fechaISO}
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows authenticated users to read Setting documents. Write operations are denied.
     * @path /databases/{database}/documents/settings/global
     * @allow (get, list): if true
     * @deny (create, update, delete): Always
     * @principle Public read, no write access for anyone.
     */
    match /settings/global {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}