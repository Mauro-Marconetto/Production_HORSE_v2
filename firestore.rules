/**
 * @fileoverview Firestore Security Rules for ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles,
 * while other collections (pieces, molds, machines) are globally accessible.
 *
 * Data Structure:
 * - User profiles are stored under /users/{userId}, where userId matches the
 *   Firebase Auth UID.
 * - Pieces, Molds, and Machines are stored in top-level collections (/pieces,
 *   /molds, /machines) and are publicly readable.
 * - Demand, Inventory, Calendars, Downtime, DowntimeAgg, Plans, Assignments, Production and Settings are stored in
 *   top-level collections and are publicly readable.
 *
 * Key Security Decisions:
 * - User profiles are only accessible to the owning user.
 * - Listing of users is disallowed to protect user privacy.
 * - Other collections are publicly readable, but writes are disallowed except
 *   where explicitly allowed by rules below.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) - If the user's UID matches the userId and the ID field on the document matches the user ID.
     * @allow (get, update, delete) - If the user's UID matches the userId.
     * @deny (create) - If the user's UID does not match the userId.
     * @deny (get, update, delete) - If the user's UID does not match the userId.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to piece documents.
     * @path /pieces/{pieceId}
     * @allow (get, list) - Anyone can read piece documents.
     * @deny (create, update, delete) - No one can create, update, or delete piece documents.
     * @principle Pieces are globally accessible, read-only data.
     */
    match /pieces/{pieceId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to mold documents.
     * @path /molds/{moldId}
     * @allow (get, list) - Anyone can read mold documents.
     * @deny (create, update, delete) - No one can create, update, or delete mold documents.
     * @principle Molds are globally accessible, read-only data.
     */
    match /molds/{moldId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to machine documents.
     * @path /machines/{machineId}
     * @allow (get, list) - Anyone can read machine documents.
     * @deny (create, update, delete) - No one can create, update, or delete machine documents.
     * @principle Machines are globally accessible, read-only data.
     */
    match /machines/{machineId} {
      allow get: if true;
      allow list: if true;
       allow create, update, delete: if false;
    }

    /**
     * @description Controls access to demand documents.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) - Anyone can read demand documents.
     * @deny (create, update, delete) - No one can create, update, or delete demand documents.
     * @principle Demand data is globally accessible, read-only data.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to inventory documents.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list) - Anyone can read inventory documents.
     * @deny (create, update, delete) - No one can create, update, or delete inventory documents.
     * @principle Inventory data is globally accessible, read-only data.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to current inventory documents.
     * @path /inventory/current/{pieceId}
     * @allow (get, list) - Anyone can read inventory documents.
     * @deny (create, update, delete) - No one can create, update, or delete inventory documents.
     */
    match /inventory/current/{pieceId} {
        allow get: if true;
        allow list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Controls access to calendar documents.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) - Anyone can read calendar documents.
     * @deny (create, update, delete) - No one can create, update, or delete calendar documents.
     * @principle Calendar data is globally accessible, read-only data.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to downtime documents.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list) - Anyone can read downtime documents.
     * @deny (create, update, delete) - No one can create, update, or delete downtime documents.
     * @principle Downtime data is globally accessible, read-only data.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to aggregated downtime documents.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) - Anyone can read aggregated downtime documents.
     * @deny (create, update, delete) - No one can create, update, or delete aggregated downtime documents.
     * @principle Aggregated downtime data is globally accessible, read-only data.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to plan documents.
     * @path /plans/{planId}
     * @allow (get, list) - Anyone can read plan documents.
     * @deny (create, update, delete) - No one can create, update, or delete plan documents.
     * @principle Plans are globally accessible, read-only data.
     */
    match /plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to assignment documents within a plan.
     * @path /plans/{planId}/assignments/{assignmentId}
     * @allow (get, list) - Anyone can read assignment documents within a plan.
     * @deny (create, update, delete) - No one can create, update, or delete assignment documents.
     * @principle Assignments are globally accessible, read-only data.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Controls access to production documents.
      * @path /production/{fechaISO}
      * @allow (get, list) - Anyone can read production documents.
      * @deny (create, update, delete) - No one can create, update, or delete production documents.
      */
     match /production/{fechaISO} {
        allow get: if true;
        allow list: if true;
        allow create, update, delete: if false;
     }

    /**
     * @description Controls access to global settings document.
     * @path /settings/global
     * @allow (get) - Anyone can read the settings document.
     * @deny (list, create, update, delete) - No one can list, create, update, or delete the settings document.
     * @principle Settings are globally accessible, read-only data.
     */
    match /settings/global {
      allow get: if true;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}