/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a data-centric security model for the ForgeFlow application, focusing on authorization independence and structural segregation for efficient access control.
 *
 * Data Structure:
 * - Top-level collections: pieces, molds, machines, demand, inventory, calendars, downtime, downtime_agg, plans, production, settings
 * - Subcollections: assignments (under plans)
 *
 * Key Security Decisions:
 * - Machines, Molds, Pieces collections are global and publicly readable, assuming that those collections do not contain any security-sensitive information.
 * - The `settings/global` document is also publicly readable.
 * - Write access to these collections is disallowed for all users.
 * - Subcollections inherit the authorization context of their parent documents.
 *
 * Access Control Patterns:
 * - Public Read, No Writes: pieces, molds, machines, production, settings/global
 * - Ownership: plans/{planId}/assignments/{assignmentId}
 * - Composite Keys: demand/{periodoYYYYWW}/{pieceId}, inventory/{pieceId}/{fechaISO}, calendars/{machineId}/{periodoYYYYWW}, downtime/{machineId}/{YYYYMM}, downtime_agg/{machineId}/{YYYYMM}
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read Pieces, but denies all writes.
     * @path /pieces/{pieceId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Pieces are considered public data.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Molds, but denies all writes.
     * @path /molds/{moldId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Molds are considered public data.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Machines, but denies all writes.
     * @path /machines/{machineId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Machines are considered public data.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Demand, but denies all writes.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Demand data is considered public data.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Inventory, but denies all writes.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Inventory data is considered public data.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
      /**
     * @description Allows anyone to read current Inventory, but denies all writes.
     * @path /inventory/current/{pieceId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Inventory data is considered public data.
     */
        match /inventory/current/{pieceId}{
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Calendars, but denies all writes.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Calendar data is considered public data.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Downtime, but denies all writes.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Downtime data is considered public data.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read DowntimeAgg, but denies all writes.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. DowntimeAgg data is considered public data.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read Plans, but denies all writes.
     * @path /plans/{planId}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Plan data is considered public data.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
        /**
         * @description Allows access to Assignments within a specific plan.
         * @path /plans/{planId}/assignments/{assignmentId}
         * @allow (get, list)
         * @deny (create, update, delete)
         * @principle Requires user to be authenticated to read/write Assignments, and enforce planId consistency on create.
         */
          match /assignments/{assignmentId} {
              allow get, list: if true;
              allow create, update, delete: if false;
          }
    }

    /**
     * @description Allows anyone to read Production data, but denies all writes.
     * @path /production/{fechaISO}
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Production data is considered public data.
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read global Settings, but denies all writes.
     * @path /settings/global
     * @allow (get, list)
     * @deny (create, update, delete)
     * @principle Public read, no writes. Global settings are considered public data.
     */
    match /settings/global {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}