/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict access control model based on path-based ownership and role-based authorization.
 *
 * Data Structure:
 * - User profiles are stored under /users/{userId}, accessible only to the owner.
 * - Core data entities (pieces, molds, machines) are stored in top-level collections and publicly readable.
 * - Demand, Inventory, Calendar, Downtime, and DowntimeAgg are also top-level collections with public read access.
 * - Plans have subcollections for Assignments, enforcing a hierarchical ownership model.
 * - Production data is stored in a top-level collection, allowing public read access.
 * - Global settings are stored in a singleton document at /settings/global and are publicly readable.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied.
 * - Public read access is granted to core data collections (pieces, molds, machines) to facilitate data discovery.
 * - Strict ownership is enforced for user profiles and plan assignments.
 *
 * Denormalization for Authorization:
 *   - To simplify rules and improve performance, authorization decisions are made directly on the documents being secured,
 *     avoiding costly `get()` calls. For example, ownership is validated directly on the user profile document itself.
 *
 * Structural Segregation:
 *   - The rules use structural segregation to differentiate between user-specific data (e.g., profiles) and
 *     publicly readable data (e.g., pieces, molds, machines). This allows for more efficient and secure list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the document.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the existing owner of the document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile with matching ID.
     * @allow (get, update, delete) User with UID 'user123' can read/write their own profile.
     * @deny (create) User with UID 'user456' cannot create a profile for 'user123'.
     * @deny (list) Listing all users is not allowed.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /pieces/{pieceId} collection.
     * @path /pieces/{pieceId}
     * @allow (get, list) Any user can read piece details.
     * @deny (create, update, delete) Only authenticated users can modify piece details.
     * @principle Allows public read access while restricting write access.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /molds/{moldId} collection.
     * @path /molds/{moldId}
     * @allow (get, list) Any user can read mold details.
     * @deny (create, update, delete) Only authenticated users can modify mold details.
     * @principle Allows public read access while restricting write access.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /machines/{machineId} collection.
     * @path /machines/{machineId}
     * @allow (get, list) Any user can read machine details.
     * @deny (create, update, delete) Only authenticated users can modify machine details.
     * @principle Allows public read access while restricting write access.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /demand/{periodoYYYYWW}/{pieceId} collection.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) Any user can read demand data.
     * @deny (create, update, delete) Only authenticated users can modify demand data.
     * @principle Allows public read access while restricting write access.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /inventory/{pieceId}/{fechaISO} collection.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list) Any user can read inventory data.
     * @deny (create, update, delete) Only authenticated users can modify inventory data.
     * @principle Allows public read access while restricting write access.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /inventory_current/{pieceId} collection.
     * @path /inventory_current/{pieceId}
     * @allow (get, list) Any user can read current inventory data.
     * @deny (create, update, delete) Only authenticated users can modify current inventory data.
     * @principle Allows public read access while restricting write access.
     */
    match /inventory_current/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /calendars/{machineId}/{periodoYYYYWW} collection.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) Any user can read calendar data.
     * @deny (create, update, delete) Only authenticated users can modify calendar data.
     * @principle Allows public read access while restricting write access.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /downtime/{machineId}/{YYYYMM} collection.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list) Any user can read downtime data.
     * @deny (create, update, delete) Only authenticated users can modify downtime data.
     * @principle Allows public read access while restricting write access.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /downtime_agg/{machineId}/{YYYYMM} collection.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) Any user can read aggregated downtime data.
     * @deny (create, update, delete) Only authenticated users can modify aggregated downtime data.
     * @principle Allows public read access while restricting write access.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /plans/{planId} collection.
     * @path /plans/{planId}
     * @allow (get, list) Any signed-in user can read plan data.
     * @deny (create, update, delete) Only authenticated users can modify plan data.
     * @principle Allows public read access while restricting write access.
     */
    match /plans/{planId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /plans/{planId}/assignments/{assignmentId} collection.
     * @path /plans/{planId}/assignments/{assignmentId}
     * @allow (get, list) Any signed-in user can read assignments data.
     * @deny (create, update, delete) Only authenticated users can modify assignments data.
     * @principle Allows public read access while restricting write access.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /production/{fechaISO} collection.
     * @path /production/{fechaISO}
     * @allow (get, list) Any user can read production data.
     * @deny (create, update, delete) Only authenticated users can modify production data.
     * @principle Allows public read access while restricting write access.
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for the /settings/global document.
     * @path /settings/global
     * @allow (get) Any user can read global settings.
     * @deny (create, update, delete) Only authenticated users can modify global settings.
     * @principle Allows public read access while restricting write access.
     */
    match /settings/global {
      allow get: if true;
      allow create, update, delete: if isSignedIn();
    }
  }
}