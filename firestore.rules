/**
 * @file Firestore Security Rules for ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of public read access for core data and owner-based write access for user-specific data.
 * Global settings are secured with strict authentication requirements.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles, accessible only to the owner.
 * - /pieces/{pieceId}, /molds/{moldId}, /machines/{machineId}: Publicly readable collections for core manufacturing data.
 * - /demand/{periodoYYYYWW}/{pieceId}, /inventory/{pieceId}/{fechaISO}, /inventory_current/{pieceId},
 *   /calendars/{machineId}/{periodoYYYYWW}, /downtime/{machineId}/{YYYYMM}, /downtime_agg/{machineId}/{YYYYMM}:
 *   Publicly readable collections for core manufacturing data.
 * - /plans/{planId}/assignments/{assignmentId}: Nested structure for production plans and their assignments,
 *   potentially secured with a plan ownership model.
 * - /production/{fechaISO}: Publicly readable collection for production data.
 * - /settings/global: Singleton document for global settings, write-protected.
 *
 * Key Security Decisions:
 * - User listing is disabled.
 * - Data validation is relaxed in prototyping mode, focusing on authorization and relational integrity.
 * - Public read access is granted only to collections explicitly intended for it.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the existing owner of the document.
     * @param {string} userId The user ID to compare against.
     * @return {boolean} True if the user is the existing owner, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description
     * Rules for user profile data.
     * Only the authenticated user can read or write their own profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete) User with ID 'user123' can access /users/user123
     * @deny (get, create, update, delete) User with ID 'user123' cannot access /users/anotherUser
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description
     * Rules for manufactured piece data.
     * Allows public read access but restricts write access.
     * @path /pieces/{pieceId}
     * @allow (get, list) Any user (signed in or not) can read piece data.
     * @deny (create, update, delete) No user can create, update, or delete piece data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for mold data used in the aluminum injection process.
     * Allows public read access but restricts write access.
     * @path /molds/{moldId}
     * @allow (get, list) Any user (signed in or not) can read mold data.
     * @deny (create, update, delete) No user can create, update, or delete mold data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for machine data used in the aluminum injection process.
     * Allows public read access but restricts write access.
     * @path /machines/{machineId}
     * @allow (get, list) Any user (signed in or not) can read machine data.
     * @deny (create, update, delete) No user can create, update, or delete machine data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for demand data for a specific piece in a given period.
     * Allows public read access but restricts write access.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) Any user (signed in or not) can read demand data.
     * @deny (create, update, delete) No user can create, update, or delete demand data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for inventory levels for a specific piece at a given date.
     * Allows public read access but restricts write access.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list) Any user (signed in or not) can read inventory data.
     * @deny (create, update, delete) No user can create, update, or delete inventory data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

      /**
     * @description
     * Rules for current inventory level for a specific piece.
     * Allows public read access but restricts write access.
     * @path /inventory_current/{pieceId}
     * @allow (get, list) Any user (signed in or not) can read inventory data.
     * @deny (create, update, delete) No user can create, update, or delete inventory data without specific authorization.
     */
    match /inventory_current/{pieceId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for planned maintenance and tryouts for a machine in a given period.
     * Allows public read access but restricts write access.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) Any user (signed in or not) can read calendar data.
     * @deny (create, update, delete) No user can create, update, or delete calendar data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for downtime events for a machine in a specific month.
     * Allows public read access but restricts write access.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list) Any user (signed in or not) can read downtime data.
     * @deny (create, update, delete) No user can create, update, or delete downtime data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for aggregated downtime data for a machine in a specific month.
     * Allows public read access but restricts write access.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) Any user (signed in or not) can read downtime aggregation data.
     * @deny (create, update, delete) No user can create, update, or delete downtime aggregation data without specific authorization.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for production plans.
     * Allows read access but restricts write access.
     * @path /plans/{planId}
     * @allow (get, list) Any user (signed in or not) can read production plan data.
     * @deny (create, update, delete) No user can create, update, or delete production plan data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.

      /**
       * @description
       * Rules for assignments of pieces to molds on machines for a specific week within a plan.
       * Only the plan owner can create, update, or delete assignments.
       * @path /plans/{planId}/assignments/{assignmentId}
       * @allow (get, list) Any user can read assignments.
       * @deny (create, update, delete) Only plan owners can create assignments.
       * @principle Enforces document ownership for write operations within the plan's assignments subcollection.
       */
      match /assignments/{assignmentId} {
        allow get, list: if true;
        allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
        allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      }
    }

    /**
     * @description
     * Rules for actual production data for a specific date.
     * Allows public read access but restricts write access.
     * @path /production/{fechaISO}
     * @allow (get, list) Any user (signed in or not) can read production data.
     * @deny (create, update, delete) No user can create, update, or delete production data without specific authorization.
     * @principle Allows public read with restricted write access.
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description
     * Rules for global settings for the application.
     * Only authenticated users can read settings.
     * Write access is denied to everyone.
     * @path /settings/global
     * @allow (get) Any authenticated user can read global settings.
     * @deny (create, update, delete) No user can create, update, or delete global settings.
     * @principle Restricts write access to global settings.
     */
    match /settings/global {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}