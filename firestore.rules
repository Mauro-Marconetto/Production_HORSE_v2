/**
 * @fileoverview Firestore Security Rules for the ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a combination of ownership-based and role-based access control.
 * User profiles are private and only accessible to the owning user. Most other data
 * (pieces, molds, machines) is publicly readable but only writable by authenticated users.
 * Global settings are readable by all but only writable by authenticated users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information; owner-only access.
 * - /pieces/{pieceId}: Stores piece data; publicly readable, only authenticated users can create, update and delete
 * - /molds/{moldId}: Stores mold data; publicly readable, only authenticated users can create, update and delete
 * - /machines/{machineId}: Stores machine data; publicly readable, only authenticated users can create, update and delete
 * - /demand/{periodoYYYYWW}/{pieceId}: Stores demand data; publicly readable, only authenticated users can create, update and delete
 * - /inventory/{pieceId}/{fechaISO}: Stores inventory data; publicly readable, only authenticated users can create, update and delete
 * - /inventory_current/{pieceId}: Stores current inventory data; publicly readable, only authenticated users can create, update and delete
 * - /calendars/{machineId}/{periodoYYYYWW}: Stores calendar data; publicly readable, only authenticated users can create, update and delete
 * - /downtime/{machineId}/{YYYYMM}: Stores downtime data; publicly readable, only authenticated users can create, update and delete
 * - /downtime_agg/{machineId}/{YYYYMM}: Stores aggregated downtime data; publicly readable, only authenticated users can create, update and delete
 * - /plans/{planId}: Stores plan data; publicly readable, only authenticated users can create, update and delete
 * - /plans/{planId}/assignments/{assignmentId}: Stores assignment data; publicly readable, only authenticated users can create, update and delete
 * - /production/{fechaISO}: Stores production data; publicly readable, only authenticated users can create, update and delete
 * - /settings/global: Stores global settings; publicly readable, only authenticated users can create, update and delete
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Read-only access is granted to public collections (pieces, molds, machines).
 * - Strict ownership is enforced for user profiles.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of an existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /******************** User Profile Rules ********************/

    /**
     * @description Allows a user to read and write their own profile data.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (get, create, update, delete) if request.auth.uid == userId
     * @deny (get, create, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.email == request.auth.token.email;
      allow update: if isExistingOwner(userId) && request.resource.data.email == resource.data.email;
      allow delete: if isExistingOwner(userId);
    }

    /******************** Piece Rules ********************/

    /**
     * @description Allows anyone to read piece data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/pieces/{pieceId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     * @principle Public read access with owner-only writes enforced.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Mold Rules ********************/

    /**
     * @description Allows anyone to read mold data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/molds/{moldId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     * @principle Public read access with owner-only writes enforced.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Machine Rules ********************/

    /**
     * @description Allows anyone to read machine data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/machines/{machineId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     * @principle Public read access with owner-only writes enforced.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Demand Rules ********************/

    /**
     * @description Allows anyone to read demand data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     * @principle Public read access with owner-only writes enforced.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Inventory Rules ********************/

    /**
     * @description Allows anyone to read inventory data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/inventory/{pieceId}/{fechaISO}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     * @principle Public read access with owner-only writes enforced.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Inventory Current Rules ********************/

    /**
     * @description Allows anyone to read current inventory data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/inventory_current/{pieceId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /inventory_current/{pieceId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Calendar Rules ********************/

    /**
     * @description Allows anyone to read calendar data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Downtime Rules ********************/

    /**
     * @description Allows anyone to read downtime data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/downtime/{machineId}/{YYYYMM}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Downtime Aggregation Rules ********************/

    /**
     * @description Allows anyone to read aggregated downtime data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Plan Rules ********************/

    /**
     * @description Allows anyone to read plan data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/plans/{planId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Assignment Rules ********************/

    /**
     * @description Allows anyone to read assignment data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/plans/{planId}/assignments/{assignmentId}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Production Rules ********************/

    /**
     * @description Allows anyone to read production data, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/production/{fechaISO}
     * @allow (get, list) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /******************** Setting Rules ********************/

    /**
     * @description Allows anyone to read global settings, but only authenticated users can create, update, or delete.
     * @path /databases/{database}/documents/settings/global
     * @allow (get) if true
     * @allow (create, update, delete) if isSignedIn()
     * @deny (create, update, delete) if !isSignedIn()
     */
    match /settings/global {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}