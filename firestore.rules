/**
 * @fileoverview Firestore Security Rules for ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a role-based access control model. Data related to Machines, Molds and Pieces collections are global.
 * User-specific data such as Assignments are secured via path-based ownership. The rules are designed to prevent unauthorized
 * data access and manipulation while allowing admins to add new users.
 *
 * Data Structure:
 * The Firestore database is structured with top-level collections for global data (pieces, molds, machines, production, settings)
 * and subcollections for plan-specific data (assignments).
 *
 * Key Security Decisions:
 * - All write operations are protected by role or ownership checks.
 * - List operations are generally allowed for global data.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the 'pieces' collection.
     * @path /databases/{database}/documents/pieces/{pieceId}
     * @allow get, list: Allows any user to read piece data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'molds' collection.
     * @path /databases/{database}/documents/molds/{moldId}
     * @allow get, list: Allows any user to read mold data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'machines' collection.
     * @path /databases/{database}/documents/machines/{machineId}
     * @allow get, list: Allows any user to read machine data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'demand' collection.
     * @path /databases/{database}/documents/demand/{periodoYYYYWW}/{pieceId}
     * @allow get, list: Allows any user to read demand data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'inventory' collection.
     * @path /databases/{database}/documents/inventory/{pieceId}/{fechaISO}
     * @allow get, list: Allows any user to read inventory data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'inventory/current' collection.
     * @path /databases/{database}/documents/inventory/current/{pieceId}
     * @allow get, list: Allows any user to read inventory data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /inventory/current/{pieceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'calendars' collection.
     * @path /databases/{database}/documents/calendars/{machineId}/{periodoYYYYWW}
     * @allow get, list: Allows any user to read calendar data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'downtime' collection.
     * @path /databases/{database}/documents/downtime/{machineId}/{YYYYMM}
     * @allow get, list: Allows any user to read downtime data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'downtime_agg' collection.
     * @path /databases/{database}/documents/downtime_agg/{machineId}/{YYYYMM}
     * @allow get, list: Allows any user to read downtime aggregation data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'plans' collection.
     * @path /databases/{database}/documents/plans/{planId}
     * @allow get, list: Allows any user to read plan data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'assignments' subcollection under a 'plan'.
     * @path /databases/{database}/documents/plans/{planId}/assignments/{assignmentId}
     * @allow get, list: Allows any user to read assignment data within a plan.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'production' collection.
     * @path /databases/{database}/documents/production/{fechaISO}
     * @allow get, list: Allows any user to read production data.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to the 'settings' document.
     * @path /databases/{database}/documents/settings/global
     * @allow get, list: Allows any user to read the global settings.
     * @allow create, update, delete: Not allowed.
     * @deny create: if true;
     * @deny update: if true;
     * @deny delete: if true;
     * @principle Public read, no writes allowed.
     */
    match /settings/global {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}