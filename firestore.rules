/**
 * @file Overview
 * This ruleset enforces a role-based access control model with an ownership component for user profiles.
 *
 * Data Structure:
 * - /users/{userId}: Stores individual user profiles. Access is restricted to the owner (the user themselves).
 * - /pieces/{pieceId}: Stores manufactured piece details.
 * - /molds/{moldId}: Stores mold details.
 * - /machines/{machineId}: Stores machine details.
 * - /demand/{periodoYYYYWW}/{pieceId}: Stores demand data.
 * - /inventory/{pieceId}/{fechaISO}: Stores inventory levels.
 * - /inventory_current/{pieceId}: Stores current inventory levels.
 * - /calendars/{machineId}/{periodoYYYYWW}: Stores calendar data.
 * - /downtime/{machineId}/{YYYYMM}: Stores downtime data.
 * - /downtime_agg/{machineId}/{YYYYMM}: Stores aggregated downtime data.
 * - /plans/{planId}: Stores production plans.
 * - /plans/{planId}/assignments/{assignmentId}: Stores plan assignments.
 * - /production/{fechaISO}: Stores production data.
 * - /settings/global: Stores global settings.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect privacy.
 * - User profiles are owner-only for read and write.
 * - Other collections are open for read and write for all authenticated users.
 * - Global settings are open for read and write for all authenticated users.
 *
 * Denormalization for Authorization:
 * - User profiles are accessed via `/users/{userId}`, where {userId} is the authenticated user's UID. No denormalization is needed as authorization is path-based.
 *
 * Structural Segregation:
 * - The design uses structural segregation by storing different data types in separate collections (e.g., 'pieces', 'molds', 'machines').
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (read, write) Authenticated user can only access their own profile.
     * @deny (read, write) Authenticated user cannot access other user profiles.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Disallow listing all users
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to piece documents.
     * @path /pieces/{pieceId}
     * @allow (read, write) Any authenticated user can read/write piece documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to pieces for authenticated users.
     */
    match /pieces/{pieceId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to mold documents.
     * @path /molds/{moldId}
     * @allow (read, write) Any authenticated user can read/write mold documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to molds for authenticated users.
     */
    match /molds/{moldId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to machine documents.
     * @path /machines/{machineId}
     * @allow (read, write) Any authenticated user can read/write machine documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to machines for authenticated users.
     */
    match /machines/{machineId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to demand documents.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (read, write) Any authenticated user can read/write demand documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to demand for authenticated users.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to inventory documents.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (read, write) Any authenticated user can read/write inventory documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to inventory for authenticated users.
     */
    match /inventory/{pieceId}/{fechaISO} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to current inventory documents.
     * @path /inventory_current/{pieceId}
     * @allow (read, write) Any authenticated user can read/write current inventory documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to current inventory for authenticated users.
     */
    match /inventory_current/{pieceId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to calendar documents.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (read, write) Any authenticated user can read/write calendar documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to calendars for authenticated users.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to downtime documents.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (read, write) Any authenticated user can read/write downtime documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to downtime for authenticated users.
     */
    match /downtime/{machineId}/{YYYYMM} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to aggregated downtime documents.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (read, write) Any authenticated user can read/write aggregated downtime documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to aggregated downtime for authenticated users.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to plan documents.
     * @path /plans/{planId}
     * @allow (read, write) Any authenticated user can read/write plan documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to plans for authenticated users.
     */
    match /plans/{planId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to assignment documents.
     * @path /plans/{planId}/assignments/{assignmentId}
     * @allow (read, write) Any authenticated user can read/write assignment documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to assignments for authenticated users.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to production documents.
     * @path /production/{fechaISO}
     * @allow (read, write) Any authenticated user can read/write production documents.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to production for authenticated users.
     */
    match /production/{fechaISO} {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Controls access to global settings document.
     * @path /settings/global
     * @allow (read, write) Any authenticated user can read/write global settings.
     * @deny (none) No specific denial conditions.
     * @principle Allows open access to settings for authenticated users.
     */
    match /settings/global {
      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}