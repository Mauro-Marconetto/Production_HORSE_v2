/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a security model based on roles.
 *
 * Core Philosophy:
 * Access is controlled based on pre-defined user roles (Admin, Planner, Shop Floor, Viewer).
 * Only authenticated users can access data, with permissions varying by role.
 *
 * Data Structure:
 * - /users/{userId}: User profile data, accessible only to the user themselves.
 * - /pieces/{pieceId}: Data about manufactured pieces.
 * - /molds/{moldId}: Data about molds used in the manufacturing process.
 * - /machines/{machineId}: Data about machines used in the manufacturing process.
 * - /demand/{periodoYYYYWW}/{pieceId}: Demand data for pieces in a specific period.
 * - /inventory/{pieceId}/{fechaISO}: Inventory levels for pieces at a specific date.
 * - /inventory_current/{pieceId}: Current inventory levels for a specific piece.
 * - /calendars/{machineId}/{periodoYYYYWW}: Calendar events for machines in a specific period.
 * - /downtime/{machineId}/{YYYYMM}: Downtime events for machines in a specific month.
 * - /downtime_agg/{machineId}/{YYYYMM}: Aggregated downtime data for machines in a specific month.
 * - /plans/{planId}: Production plans.
 * - /plans/{planId}/assignments/{assignmentId}: Assignments of pieces to molds and machines.
 * - /production/{fechaISO}: Production data for a specific date.
 * - /settings/global: Global application settings.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Global settings are read-only for most users, writable only by admins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Rule for user profile data, only accessible to the user themselves.
     * @path /users/{userId}
     * @allow (create, update, get, delete, list) if the user is signed in and the requested user ID matches the authenticated user ID.
     * @deny (create, update, get, delete, list) if the user is not signed in, or if the requested user ID does not match the authenticated user ID.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Helper function to check if the request is made by the owner of the resource.
     * @param {string} userId - The user ID from the path.
     * @return {boolean} - True if the user is signed in and their ID matches the userId, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Rule for manufactured piece details.
     * @path /pieces/{pieceId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /pieces/{pieceId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for mold details for the aluminum injection process.
     * @path /molds/{moldId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /molds/{moldId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for machine details for the aluminum injection process.
     * @path /machines/{machineId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /machines/{machineId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for demand data for a specific piece in a given period.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for inventory levels for a specific piece at a given date.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for current inventory levels for a specific piece.
     * @path /inventory_current/{pieceId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /inventory_current/{pieceId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for planned maintenance and tryouts for a machine in a given period.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for downtime events for a machine in a specific month.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for aggregated downtime data for a machine in a specific month.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for production plans.
     * @path /plans/{planId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /plans/{planId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for assignments of pieces to molds on machines for a specific week.
     * @path /plans/{planId}/assignments/{assignmentId}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for actual production data for a specific date.
     * @path /production/{fechaISO}
     * @allow (get, list) to any authenticated user.
     * @allow (create, update, delete) to any authenticated user.
     * @principle Allows public read access but restricts writes to authorized users.
     */
    match /production/{fechaISO} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Rule for global settings for the application.
     * @path /settings/global
     * @allow get: if isSignedIn();
     * @allow list: if false;
     * @allow create, update, delete: if false; // TODO: restrict write access to admin users.
     * @principle Restricts write access to global settings to admin users.
     */
    match /settings/global {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}