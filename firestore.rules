/**
 * @fileoverview Firestore Security Rules for ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a security model based on a combination of ownership and public read access.
 *
 * Data Structure:
 * The Firestore database is structured with a mix of top-level collections (e.g., 'pieces', 'molds', 'machines', 'production', 'clients') and user-specific subcollections ('users/{userId}'). Some collections use composite keys in the path.
 *
 * Key Security Decisions:
 * - User listing is generally disallowed.
 * - Most top-level collections allow public read access but require owner-only access for writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to determine if the request is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to determine if the authenticated user ID matches the provided user ID.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Helper function to determine if the authenticated user is the existing owner of the document
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Secures user profile information, allowing only the user to read/write their own profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates their profile at /users/user123.
     * @deny (create) User with UID 'user123' attempts to create a profile for /users/otherUser.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures application roles and their page access permissions.
     * @path /roles/{roleId}
     * @allow (get, list) Any authenticated user can read role information.
     * @deny (create, update, delete) No user can create, update, or delete roles.
     * @principle Restricts write access to roles.
     */
    match /roles/{roleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Secures manufactured pieces information. Allows public read access, owner-only writes.
     * @path /pieces/{pieceId}
     * @allow (get, list) Any user can read piece information.
     * @deny (create, update, delete) Only the owner can write piece information.
     * @principle Enforces owner-only access for writes.
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures mold information used in the aluminum injection process. Allows public read access, owner-only writes.
     * @path /molds/{moldId}
     * @allow (get, list) Any user can read mold information.
     * @deny (create, update, delete) Only the owner can write mold information.
     * @principle Enforces owner-only access for writes.
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures machine information used in production. Allows public read access, owner-only writes.
     * @path /machines/{machineId}
     * @allow (get, list) Any user can read machine information.
     * @deny (create, update, delete) Only the owner can write machine information.
     * @principle Enforces owner-only access for writes.
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures demand data for a specific piece in a specific period. Allows public read access, owner-only writes.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) Any user can read demand information.
     * @deny (create, update, delete) Only the owner can write demand information.
     * @principle Enforces owner-only access for writes.
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures inventory levels for a specific piece on a specific date. Allows public read access, owner-only writes.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list) Any user can read inventory information.
     * @deny (create, update, delete) Only the owner can write inventory information.
     * @principle Enforces owner-only access for writes.
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures the current inventory level for a specific piece. Allows public read access, owner-only writes.
     * @path /inventory/current/{pieceId}
     * @allow (get, list) Any user can read the current inventory information.
     * @deny (create, update, delete) Only the owner can write the current inventory information.
     */
    match /inventory/current/{pieceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures calendar events for a specific machine in a specific period. Allows public read access, owner-only writes.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) Any user can read calendar information.
     * @deny (create, update, delete) Only the owner can write calendar information.
     * @principle Enforces owner-only access for writes.
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures downtime events for a specific machine in a specific month. Allows public read access, owner-only writes.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list) Any user can read downtime information.
     * @deny (create, update, delete) Only the owner can write downtime information.
     * @principle Enforces owner-only access for writes.
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures aggregated downtime data for a specific machine in a specific month. Allows public read access, owner-only writes.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) Any user can read aggregated downtime information.
     * @deny (create, update, delete) Only the owner can write aggregated downtime information.
     * @principle Enforces owner-only access for writes.
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures production plans. Allows public read access, owner-only writes.
     * @path /plans/{planId}
     * @allow (get, list) Any user can read plan information.
     * @deny (create, update, delete) Only the owner can write plan information.
     * @principle Enforces owner-only access for writes.
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures assignments of pieces and molds to machines for a specific week within a production plan. Allows public read access, owner-only writes.
     * @path /plans/{planId}/assignments/{assignmentId}
     * @allow (get, list) Any user can read assignment information.
     * @deny (create, update, delete) Only the owner can write assignment information.
     * @principle Enforces owner-only access for writes.
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures actual production data for a specific date. Allows public read access, owner-only writes.
     * @path /production/{fechaISO}
     * @allow (get, list) Any user can read production information.
     * @deny (create, update, delete) Only the owner can write production information.
     * @principle Enforces owner-only access for writes.
     */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures global settings for the application.
     * @path /settings/global
     * @allow get: if true;
     * @deny write: Always denies all writes to global settings.
     * @principle Restricts write access to global settings.
     */
    match /settings/global {
      allow get: if true;
      allow create, update, delete: if false;
      allow list: if false;
    }

    /**
     * @description Secures client information. Allows public read access, owner-only writes.
     * @path /clients/{clientId}
     * @allow (get, list) Any user can read client information.
     * @deny (create, update, delete) Only the owner can write client information.
     * @principle Enforces owner-only access for writes.
     */
    match /clients/{clientId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}