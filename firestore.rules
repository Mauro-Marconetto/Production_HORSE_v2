/**
 * @fileoverview Firestore Security Rules for ForgeFlow application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles
 * and allows public read access to shared resources like machines, molds, and pieces.
 *
 * Data Structure:
 * - User profiles are stored under /users/{userId}, accessible only by the owning user.
 * - Global data like machines, molds, pieces, and clients are stored in top-level collections
 *   and are publicly readable.
 * - Plans and their assignments are stored under /plans/{planId}/assignments/{assignmentId}.
 * - Production data is stored under /production/{fechaISO}.
 *
 * Key Security Decisions:
 * - User listing is disallowed for privacy.
 * - Global settings are publicly readable but not writable by clients.
 * - Ambiguous relationships default to the most secure interpretation: owner-only access.
 *
 * Denormalization for Authorization:
 *  - N/A: All authorization checks are based on path-based ownership.
 * Structural Segregation:
 *  - The app uses structural segregation to avoid the need for boolean flags to grant access.
 *    For example, the production data is under /production/{fechaISO}.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile access, ensuring only the owner can read/write.
     * @path /users/{userId}
     * @allow (create) Signed-in user creates their own profile.
     * @allow (get, update, delete, list) Signed-in user accesses their own profile.
     * @deny  (create) Signed-in user attempts to create a profile for another user.
     * @deny  (get, update, delete, list) Signed-in user attempts to access another user's profile.
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId} {
      allow get, update, delete, list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * @description Manages access to application roles, which are globally readable.
     * @path /roles/{roleId}
     * @allow (get, list) Any user can read the list of roles and any specific role.
     * @deny (create, update, delete) No user can create, update, or delete roles.
     * @principle Roles are read-only and managed by administrators only (not implemented in this prototype).
     */
    match /roles/{roleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to piece data, which is publicly readable.
     * @path /pieces/{pieceId}
     * @allow (get, list) Any user can read the list of pieces and any specific piece.
     * @deny (create, update, delete) No user can create, update, or delete pieces.
     * @principle Pieces are read-only and managed by administrators only (not implemented in this prototype).
     */
    match /pieces/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to mold data, which is publicly readable.
     * @path /molds/{moldId}
     * @allow (get, list) Any user can read the list of molds and any specific mold.
     * @deny (create, update, delete) No user can create, update, or delete molds.
     * @principle Molds are read-only and managed by administrators only (not implemented in this prototype).
     */
    match /molds/{moldId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to machine data, which is publicly readable.
     * @path /machines/{machineId}
     * @allow (get, list) Any user can read the list of machines and any specific machine.
     * @deny (create, update, delete) No user can create, update, or delete machines.
     * @principle Machines are read-only and managed by administrators only (not implemented in this prototype).
     */
    match /machines/{machineId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to demand data, which is publicly readable.
     * @path /demand/{periodoYYYYWW}/{pieceId}
     * @allow (get, list) Any user can read demand data.
     * @deny (create, update, delete) No user can create, update, or delete demand data.
     * @principle Demand data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /demand/{periodoYYYYWW}/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to inventory data, which is publicly readable.
     * @path /inventory/{pieceId}/{fechaISO}
     * @allow (get, list) Any user can read inventory data.
     * @deny (create, update, delete) No user can create, update, or delete inventory data.
     * @principle Inventory data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /inventory/{pieceId}/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

     /**
      * @description Manages access to current inventory data, which is publicly readable.
      * @path inventory/current/{pieceId}
      * @allow (get, list) Any user can read current inventory data.
      * @deny (create, update, delete) No user can create, update, or delete current inventory data.
      * @principle Current inventory data is read-only and managed by administrators only (not implemented in this prototype).
      */
    match /inventory/current/{pieceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to calendar data, which is publicly readable.
     * @path /calendars/{machineId}/{periodoYYYYWW}
     * @allow (get, list) Any user can read calendar data.
     * @deny (create, update, delete) No user can create, update, or delete calendar data.
     * @principle Calendar data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /calendars/{machineId}/{periodoYYYYWW} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to downtime data, which is publicly readable.
     * @path /downtime/{machineId}/{YYYYMM}
     * @allow (get, list) Any user can read downtime data.
     * @deny (create, update, delete) No user can create, update, or delete downtime data.
     * @principle Downtime data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /downtime/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to aggregated downtime data, which is publicly readable.
     * @path /downtime_agg/{machineId}/{YYYYMM}
     * @allow (get, list) Any user can read aggregated downtime data.
     * @deny (create, update, delete) No user can create, update, or delete aggregated downtime data.
     * @principle Aggregated downtime data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /downtime_agg/{machineId}/{YYYYMM} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to production plans, which are publicly readable.
     * @path /plans/{planId}
     * @allow (get, list) Any user can read production plans.
     * @deny (create, update, delete) No user can create, update, or delete production plans.
     * @principle Production plans are read-only and managed by administrators only (not implemented in this prototype).
     */
    match /plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to assignment data within a plan, which is publicly readable.
     * @path /plans/{planId}/assignments/{assignmentId}
     * @allow (get, list) Any user can read assignment data within a specific plan.
     * @deny (create, update, delete) No user can create, update, or delete assignment data.
     * @principle Assignment data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /plans/{planId}/assignments/{assignmentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

   /**
    * @description Manages access to production data, which is publicly readable.
    * @path /production/{fechaISO}
    * @allow (get, list) Any user can read production data for a specific date.
    * @deny (create, update, delete) No user can create, update, or delete production data.
    * @principle Production data is read-only and managed by administrators only (not implemented in this prototype).
    */
    match /production/{fechaISO} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages access to global settings, which are publicly readable.
     * @path /settings/global
     * @allow (get) Any user can read global settings.
     * @deny (create, update, delete, list) No user can create, update, or delete global settings.
     * @principle Global settings are read-only and managed by administrators only (not implemented in this prototype).
     */
    match /settings/global {
      allow get: if true;
      allow create, update, delete, list: if false;
    }

    /**
     * @description Manages access to client data, which is publicly readable.
     * @path /clients/{clientId}
     * @allow (get, list) Any user can read client data.
     * @deny (create, update, delete) No user can create, update, or delete client data.
     * @principle Client data is read-only and managed by administrators only (not implemented in this prototype).
     */
    match /clients/{clientId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    // functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
  }
}